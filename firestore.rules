rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check authentication
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // User documents
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
      
      // User's friends sub-collection
      match /friends/{friendId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
    }
    
    // Game documents (existing ledger games)
    match /games/{gameId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        (request.auth.uid == resource.data.hostUid || 
         request.auth.uid in resource.data.players[].uid);
      allow delete: if request.auth.uid == resource.data.hostUid;
      
      // Game chat sub-collection
      match /chat/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
      }
    }
    
    // ============================================
    // 德州撲克遊戲規則 (Texas Hold'em Poker Rules)
    // ============================================
    
    // Poker game rooms
    match /pokerGames/{gameId} {
      // Anyone authenticated can read game state
      allow read: if isAuthenticated();
      
      // Anyone authenticated can create a game
      allow create: if isAuthenticated() &&
        request.resource.data.meta.createdBy == request.auth.uid;
      
      // Only authenticated players can update the game
      // Detailed validation should be done in Cloud Functions
      allow update: if isAuthenticated();
      
      // Only the creator can delete the game
      allow delete: if isAuthenticated() && 
        resource.data.meta.createdBy == request.auth.uid;
      
      // Hand history sub-collection
      // Records of each hand played
      match /hands/{handId} {
        // Anyone in the game can read hand history
        allow read: if isAuthenticated();
        
        // Only Cloud Functions can write hand history
        // This ensures game integrity
        allow write: if false;
      }
      
      // Private hole cards sub-collection
      // Each player's private cards
      match /private/{userId} {
        // Only the player can read their own hole cards
        allow read: if isOwner(userId);
        
        // Only Cloud Functions can write hole cards
        // This prevents cheating
        allow write: if false;
      }
    }
    
    // ============================================
    // Additional collections can be added here
    // ============================================
  }
}
